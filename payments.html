<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Paiements & Crédit – Zarbiti Plateforme</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="login-container" id="locked" style="max-width:450px;">
  <h1>Paiements / Crédit Livraison</h1>
  <div class="info-msg">Veuillez vous connecter <a href="index.html">ici</a> avec le rôle Comptabilité ou Admin.</div>
</div>
<div id="pageContent" class="hidden container" style="max-width:980px;">
  <nav>
    <ul>
      <li><a href="index.html">Accueil</a></li>
      <li><a href="orders.html">Commandes</a></li>
      <li><a href="production.html">Production</a></li>
      <li><a href="parcels.html">Livraisons/Colis</a></li>
    </ul>
    <span class="role-badge" id="rolePay"></span>
    <button onclick="logout()" style="float:right;">Déconnexion</button>
  </nav>

  <h2>Enregistrer un paiement livraison</h2>
  <form id="payForm" autocomplete="off" style="margin-bottom:32px;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:11px;">
      <div>
        <label>Date paiement</label>
        <input name="pay_date" type="date" required>
      </div>
      <div>
        <label>Société livraison</label>
        <select name="company">
          <option>ZBS</option>
          <option>Rapide</option>
          <option>Aramex</option>
          <option>Surexpress</option>
          <option>Autre</option>
        </select>
      </div>
      <div>
        <label>Montant payé (DT)</label>
        <input name="amount" type="number" min="0" step="1" required>
      </div>
    </div>
    <button type="submit" style="margin-top:11px;">Ajouter paiement</button>
  </form>

  <h2>Vue crédit par société</h2>
  <table id="creditTable" style="width:100%;margin-top:14px;">
    <thead>
      <tr>
        <th>Société</th>
        <th>Total COD généré</th>
        <th>Total payé</th>
        <th>Solde restant</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:14px;">
    <button onclick="exportCSV()">Exporter CSV paiements</button>
    <button onclick="clearAll()">Tout supprimer</button>
  </div>
</div>

<script>
const REQUIRED_ROLE = ['admin','compta'];
function checkLogin() {
  let user = localStorage.getItem("zarbiti_user");
  if(!user) return false;
  let obj=JSON.parse(user);
  if(!REQUIRED_ROLE.includes(obj.role)) return false;
  document.getElementById('locked').classList.add('hidden');
  document.getElementById('pageContent').classList.remove('hidden');
  document.getElementById('rolePay').innerText = obj.role.charAt(0).toUpperCase()+obj.role.slice(1);
  return true;
}
window.onload = checkLogin;

// Paiements enregistrés
let payments = JSON.parse(localStorage.getItem("zarbiti_payments")||"[]");
// Colis livrés
let parcels = JSON.parse(localStorage.getItem("zarbiti_parcels")||"[]");

// Ajouter paiement
document.getElementById('payForm').onsubmit = function(e){
  e.preventDefault();
  let f = e.target;
  let p = {
    pay_date: f["pay_date"].value,
    company: f["company"].value,
    amount: parseFloat(f["amount"].value),
    created_at: new Date().toISOString()
  };
  payments.push(p);
  persistPayments();
  f.reset();
  updateCreditTable();
};

// Calcul crédit
function updateCreditTable() {
  // Groupes sociétés
  let companies = ["ZBS","Rapide","Aramex","Surexpress","Autre"];
  let tbody="";
  companies.forEach(comp=>{
    // Total COD généré : tous colis livrés, somme cod_amount
    let cod = parcels.filter(p=>p.company===comp && p.delivery_status==="Livré")
                     .reduce((a,b)=>a+(parseFloat(b.cod_amount)||0),0);
    // Total payé (somme des paiements enregistrés pour cette société)
    let paid = payments.filter(p=>p.company===comp)
                       .reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
    let remain = cod-paid;
    tbody+=`<tr>
      <td>${comp}</td>
      <td>${cod.toFixed(2)}</td>
      <td>${paid.toFixed(2)}</td>
      <td style="color:${remain>0?'#f7bc6b':'#91c97a'};font-weight:700;">${remain.toFixed(2)}</td>
    </tr>`;
  });
  document.getElementById('creditTable').querySelector('tbody').innerHTML = tbody;
}
function persistPayments(){
  localStorage.setItem("zarbiti_payments",JSON.stringify(payments));
}
window.exportCSV = function(){
  let FIELDS=["pay_date","company","amount","created_at"];
  let csv = FIELDS.join(";")+"\n";
  csv += payments.map(p=>FIELDS.map(f=>'"'+(p[f]||"")+'"').join(";")).join("\n");
  const link = document.createElement('a');
  link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
  link.download = "zarbiti-paiements.csv";
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
window.clearAll = function(){
  if(confirm("Tout supprimer les paiements ?")){
    payments = [];
    persistPayments();
    updateCreditTable();
  }
}
window.logout = function(){
  localStorage.removeItem("zarbiti_user");
  location.href="index.html";
}
updateCreditTable();
</script>
</body>
</html>
